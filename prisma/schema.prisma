generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PLATFORM MODELS (Super Admin level)
// ============================================================================

model PlatformAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("admin") // "admin", "superadmin"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
  @@map("platform_admin")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

model Subscription {
  id                 String             @id @default(cuid())
  tenantId           String             @unique
  plan               String // "free", "starter", "pro", "enterprise"
  status             SubscriptionStatus @default(TRIAL)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEndsAt        DateTime?
  cancelledAt        DateTime?
  metadata           Json? // Payment gateway info, etc
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("subscription")
}

// ============================================================================
// BASE MODELS (Shared across all business types)
// ============================================================================

model Tenant {
  id           String   @id @default(cuid())
  slug         String   @unique // untuk subdomain/URL: warungpak.yourapp.com
  name         String
  businessType String // "restaurant", "retail", "salon"
  ownerEmail   String   @default("") // Email pemilik tenant
  ownerName    String   @default("") // Nama pemilik tenant
  plan         String   @default("free") // "free", "starter", "pro"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  subscription  Subscription?
  adminUsers    AdminUser[]
  siteSettings  SiteSettings[]
  landingHeroes LandingHero[]
  reviews       Review[]
  businessInfo  BusinessInfo?
  themeConfig   ThemeConfig?

  // Restaurant module relations
  categories   Category[]
  menuItems    MenuItem[]
  tables       Table[]
  reservations Reservation[]
  orders       Order[]
  payments     Payment[]

  @@index([ownerEmail])
  @@map("tenant")
}

model BusinessInfo {
  id           String   @id @default(cuid())
  tenantId     String   @unique
  name         String
  description  String?
  address      String?
  phoneNumber  String?
  email        String?
  mapsUrl      String?
  mapsEmbedUrl String?
  metadata     Json? // Module-specific fields (openingHours, etc)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("business_info")
}

model ThemeConfig {
  id             String   @id @default(cuid())
  tenantId       String   @unique
  primaryColor   String   @default("#16a34a")
  secondaryColor String   @default("#ca8a04")
  fontFamily     String   @default("Inter")
  layoutVariant  String   @default("default") // "default", "minimal", "bold"
  customCss      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("theme_config")
}

model AdminUser {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  name         String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([email])
  @@map("admin_user")
}

enum OrderType {
  DINE_IN
  TAKEAWAY
}

enum OrderStatus {
  PLACED
  ACCEPTED
  IN_KITCHEN
  READY
  COMPLETED
  CANCELLED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum PaymentProvider {
  MIDTRANS
  CASH
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
}

// ============================================================================
// RESTAURANT MODULE (resto_* tables)
// ============================================================================

model Category {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("resto_category")
}

model MenuItem {
  id          String   @id @default(cuid())
  tenantId    String
  categoryId  String?
  name        String
  description String?
  price       Int
  photoUrl    String?
  isAvailable Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category   Category?   @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([isFeatured])
  @@map("resto_menu_item")
}

model Table {
  id        String   @id @default(cuid())
  tenantId  String
  tableCode String
  name      String?
  capacity  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reservations Reservation[]
  orders       Order[]

  @@unique([tenantId, tableCode])
  @@index([tenantId])
  @@map("resto_table")
}

model Reservation {
  id            String            @id @default(cuid())
  tenantId      String
  tableId       String?
  customerName  String
  customerPhone String
  partySize     Int
  startAt       DateTime
  notes         String?
  status        ReservationStatus @default(PENDING)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  table  Table?  @relation(fields: [tableId], references: [id])
  orders Order[]

  @@index([tenantId])
  @@index([tableId])
  @@index([status])
  @@index([startAt])
  @@map("resto_reservation")
}

model Order {
  id          String      @id @default(cuid())
  tenantId    String
  orderNumber String
  type        OrderType
  status      OrderStatus @default(PLACED)

  tableId       String?
  reservationId String?

  customerName  String?
  customerPhone String?
  notes         String?

  subtotal Int @default(0)
  total    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  table       Table?       @relation(fields: [tableId], references: [id])
  reservation Reservation? @relation(fields: [reservationId], references: [id])
  items       OrderItem[]
  payments    Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([tableId])
  @@index([reservationId])
  @@index([status])
  @@index([type])
  @@map("resto_order")
}

model OrderItem {
  id         String @id @default(cuid())
  orderId    String
  menuItemId String

  nameSnapshot  String
  priceSnapshot Int
  qty           Int
  notes         String?
  lineTotal     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([orderId])
  @@index([menuItemId])
  @@map("resto_order_item")
}

model Payment {
  id       String          @id @default(cuid())
  tenantId String
  orderId  String
  provider PaymentProvider @default(MIDTRANS)
  amount   Int
  currency String          @default("IDR")
  status   PaymentStatus   @default(PENDING)

  providerRef     String?
  providerPayload Json?
  paidAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
  @@index([status])
  @@map("resto_payment")
}

// ============================================================================
// CMS / LANDING PAGE MODELS (Base with tenantId)
// ============================================================================

model Review {
  id          String   @id @default(cuid())
  tenantId    String
  authorName  String
  rating      Int
  comment     String?
  isPublished Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([isPublished])
  @@index([isFeatured])
  @@index([rating])
  @@map("review")
}

model LandingHero {
  id          String   @id @default(cuid())
  tenantId    String
  title       String
  subtitle    String
  description String
  ctaText     String
  ctaLink     String
  promoText   String?
  imageUrl    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("landing_hero")
}

model SiteSettings {
  id       String @id @default(cuid())
  tenantId String
  key      String // 'header' or 'footer'

  // Header settings
  logoUrl  String?
  logoText String?

  // Social media links
  facebookUrl  String?
  instagramUrl String?
  twitterUrl   String?

  // Footer settings
  copyrightText String?
  footerLinks   Json? // JSON array of {label, url}

  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("site_settings")
}
